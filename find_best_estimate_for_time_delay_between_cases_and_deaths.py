import numpy as np
from numba import jit
import matplotlib.pyplot as plt
import scipy.integrate as integrate
#from scipy.integrate import odeint
import scipy.signal as signal

######

mu_C=1/5

dates = ['2020-04-12','2020-04-13','2020-04-14','2020-04-15','2020-04-16','2020-04-17','2020-04-18','2020-04-19','2020-04-20','2020-04-21','2020-04-22','2020-04-23','2020-04-24','2020-04-25','2020-04-26','2020-04-27','2020-04-28','2020-04-29','2020-04-30','2020-05-01','2020-05-02','2020-05-03','2020-05-04','2020-05-05','2020-05-06','2020-05-07','2020-05-08','2020-05-09','2020-05-10','2020-05-11','2020-05-12','2020-05-13','2020-05-14','2020-05-15','2020-05-16','2020-05-17','2020-05-18','2020-05-19','2020-05-20','2020-05-21','2020-05-22','2020-05-23','2020-05-24','2020-05-25','2020-05-26','2020-05-27','2020-05-28','2020-05-29','2020-05-30','2020-05-31','2020-06-01','2020-06-02','2020-06-03','2020-06-04','2020-06-05','2020-06-06','2020-06-07','2020-06-08','2020-06-09','2020-06-10','2020-06-11','2020-06-12','2020-06-13','2020-06-14','2020-06-15','2020-06-16','2020-06-17','2020-06-18','2020-06-19','2020-06-20','2020-06-21','2020-06-22','2020-06-23','2020-06-24','2020-06-25','2020-06-26','2020-06-27','2020-06-28','2020-06-29','2020-06-30','2020-07-01','2020-07-02','2020-07-03','2020-07-04','2020-07-05','2020-07-06','2020-07-07','2020-07-08','2020-07-09','2020-07-10','2020-07-11','2020-07-12','2020-07-13','2020-07-14','2020-07-15','2020-07-16','2020-07-17','2020-07-18','2020-07-19','2020-07-20','2020-07-21','2020-07-22','2020-07-23','2020-07-24','2020-07-25','2020-07-26','2020-07-27','2020-07-28','2020-07-29','2020-07-30','2020-07-31','2020-08-01','2020-08-02','2020-08-03','2020-08-04','2020-08-05','2020-08-06','2020-08-07','2020-08-08','2020-08-09','2020-08-10','2020-08-11','2020-08-12','2020-08-13','2020-08-14','2020-08-15','2020-08-16','2020-08-17','2020-08-18','2020-08-19','2020-08-20','2020-08-21','2020-08-22','2020-08-23','2020-08-24','2020-08-25','2020-08-26','2020-08-27','2020-08-28','2020-08-29','2020-08-30','2020-08-31','2020-09-01','2020-09-02','2020-09-03','2020-09-04','2020-09-05','2020-09-06','2020-09-07','2020-09-08','2020-09-09','2020-09-10','2020-09-11','2020-09-12','2020-09-13','2020-09-14','2020-09-15','2020-09-16','2020-09-17','2020-09-18','2020-09-19','2020-09-20','2020-09-21','2020-09-22','2020-09-23','2020-09-24','2020-09-25','2020-09-26','2020-09-27','2020-09-28','2020-09-29','2020-09-30','2020-10-01','2020-10-02','2020-10-03','2020-10-04','2020-10-05','2020-10-06','2020-10-07','2020-10-08','2020-10-09','2020-10-10','2020-10-11','2020-10-12','2020-10-13','2020-10-14','2020-10-15','2020-10-16','2020-10-17','2020-10-18','2020-10-19','2020-10-20','2020-10-21','2020-10-22','2020-10-23','2020-10-24','2020-10-25','2020-10-26','2020-10-27','2020-10-28','2020-10-29','2020-10-30','2020-10-31','2020-11-01','2020-11-02','2020-11-03','2020-11-04','2020-11-05','2020-11-06','2020-11-07','2020-11-08','2020-11-09','2020-11-10','2020-11-11','2020-11-12','2020-11-13','2020-11-14','2020-11-15','2020-11-16','2020-11-17','2020-11-18','2020-11-19','2020-11-20','2020-11-21','2020-11-22','2020-11-23','2020-11-24','2020-11-25','2020-11-26','2020-11-27','2020-11-28','2020-11-29','2020-11-30','2020-12-01','2020-12-02','2020-12-03','2020-12-04','2020-12-05','2020-12-06','2020-12-07','2020-12-08','2020-12-09','2020-12-10','2020-12-11','2020-12-12','2020-12-13','2020-12-14','2020-12-15','2020-12-16','2020-12-17','2020-12-18','2020-12-19','2020-12-20','2020-12-21','2020-12-22','2020-12-23','2020-12-24','2020-12-25','2020-12-26','2020-12-27','2020-12-28','2020-12-29','2020-12-30','2020-12-31','2021-01-01','2021-01-02','2021-01-03','2021-01-04','2021-01-05','2021-01-06','2021-01-07','2021-01-08','2021-01-09','2021-01-10','2021-01-11','2021-01-12','2021-01-13','2021-01-14','2021-01-15','2021-01-16','2021-01-17','2021-01-18','2021-01-19','2021-01-20','2021-01-21','2021-01-22','2021-01-23','2021-01-24','2021-01-25','2021-01-26','2021-01-27','2021-01-28','2021-01-29','2021-01-30','2021-01-31','2021-02-01','2021-02-02','2021-02-03','2021-02-04','2021-02-05','2021-02-06','2021-02-07','2021-02-08','2021-02-09','2021-02-10','2021-02-11','2021-02-12','2021-02-13','2021-02-14','2021-02-15','2021-02-16','2021-02-17','2021-02-18','2021-02-19','2021-02-20','2021-02-21','2021-02-22','2021-02-23','2021-02-24','2021-02-25','2021-02-26','2021-02-27','2021-02-28','2021-03-01','2021-03-02','2021-03-03','2021-03-04','2021-03-05','2021-03-06','2021-03-07','2021-03-08','2021-03-09','2021-03-10','2021-03-11','2021-03-12','2021-03-13','2021-03-14','2021-03-15','2021-03-16','2021-03-17','2021-03-18','2021-03-19','2021-03-20','2021-03-21','2021-03-22']
cumcases = [555613,580876,607926,636817,668131,700179,732660,759492,784829,812572,841061,869856,906056,939017,966323,988903,1013417,1040925,1070403,1104625,1133512,1158771,1181206,1205360,1229731,1258108,1285119,1310999,1330612,1348935,1371191,1391914,1418927,1444044,1469103,1488174,1509868,1530274,1553354,1578825,1602738,1624090,1644547,1663576,1682485,1700958,1723590,1748013,1772235,1791796,1812611,1833862,1853764,1875126,1905385,1928158,1946394,1964104,1982351,2003952,2026709,2052481,2078257,2097471,2117359,2141118,2168033,2196145,2227963,2260774,2286042,2318659,2354866,2390968,2431527,2477469,2519148,2560046,2601628,2646832,2698282,2753411,2806538,2851782,2901678,2947994,3008700,3068370,3130708,3198861,3258896,3317535,3376215,3444749,3512816,3588510,3660651,3724191,3785358,3846883,3911865,3982167,4050336,4124596,4188835,4245072,4301731,4368507,4440059,4507998,4576675,4633896,4679850,4726174,4785385,4839202,4898705,4958308,5013302,5060141,5107808,5156094,5211669,5262893,5328239,5375899,5415854,5451952,5497111,5543798,5587583,5637037,5680698,5715198,5752305,5792333,5836097,5881585,5928842,5972846,6007264,6044953,6087518,6127627,6164487,6215347,6258809,6290385,6314511,6341717,6376283,6411189,6459149,6500864,6535012,6569759,6609246,6647597,6693020,6742451,6785302,6824755,6876838,6917073,6954872,7002403,7055488,7100757,7139158,7172559,7216772,7257494,7303206,7358329,7407303,7443185,7483009,7528391,7578381,7637135,7693756,7748904,7794786,7837170,7889568,7949245,8014339,8083610,8140362,8189886,8258026,8320214,8382868,8459326,8542017,8624972,8687600,8755269,8833222,8912016,9003570,9103063,9192884,9297929,9383879,9511485,9615471,9744927,9873208,10000910,10125066,10203112,10348442,10494967,10659901,10840290,11008014,11144079,11306967,11470830,11643896,11835369,12034160,12213409,12360114,12534511,12709975,12893465,13005745,13213975,13369491,13509690,13670310,13858527,14061082,14284692,14517477,14733023,14914034,15108895,15333385,15555920,15787436,16027412,16244797,16432601,16626313,16836417,17083061,17322739,17574674,17766568,17954314,18153413,18351480,18581041,18775207,18872822,19099125,19254759,19429410,19629601,19863235,20098800,20252310,20552726,20761467,20945766,21180814,21436203,21714268,22007515,22270172,22483440,22698422,22925376,23155725,23391339,23634087,23835726,24013519,24156910,24333648,24516852,24710602,24901279,25071901,25202932,25354901,25502471,25655710,25824970,25991464,26133786,26245805,26380978,26496311,26617922,26741846,26876208,26980195,27069854,27160197,27255817,27350956,27456653,27556262,27643381,27708401,27762595,27825319,27895423,27964979,28044574,28116088,28173139,28229362,28301617,28376317,28453812,28530741,28595133,28646371,28705285,28762326,28829520,28897518,28963921,29022116,29063082,29108096,29165791,29223730,29286134,29347338,29400553,29438775,29495424,29549235,29608206,29668587,29730000,29785285,29818930,29869514]
cumdeaths = [22363,23940,26226,28718,33279,37154,39053,41088,42583,44904,47093,50420,52441,54253,55444,56866,58947,61451,63353,65315,66781,68157,69437,71511,73830,76057,77584,79185,79987,81178,82847,84558,86344,87971,89181,90041,90880,92359,93858,95083,96335,97418,98061,98595,99290,100750,101872,103043,104015,104646,105411,106362,107364,108392,109527,110231,110690,111157,112112,113012,113873,114722,115460,115785,116175,116990,117740,118429,119088,119652,119931,120372,121101,121843,124257,124892,125394,125699,126039,127255,127909,128607,129281,129562,129868,130224,131367,132163,133161,133955,134673,135111,135542,136449,137397,138352,139251,140111,140539,140959,142035,143233,144344,145547,146482,147017,148134,149407,150802,152157,153404,154522,154960,155545,156910,158320,160160,161399,162466,163026,163607,164636,166127,167197,168538,169543,170148,170634,171902,173221,174313,175399,176383,176874,177350,178578,179755,180866,181825,182727,183186,183682,184726,185791,186821,187769,188564,189002,189290,189740,190913,191809,192977,193703,194123,194559,195765,196713,197576,198488,199205,199463,199892,200924,201974,202876,203804,204575,204878,205225,206098,207049,207923,208763,209453,209831,210305,211000,211911,212895,213855,214503,214948,215334,216136,217123,217969,218887,219626,220075,220543,221467,222626,223497,224453,225385,225810,226321,227309,228340,229350,230398,231325,231811,232346,233939,235090,236252,237509,238610,239170,239947,241408,242898,244265,245464,246810,247583,248408,250125,252061,254100,256057,257671,258701,259798,261926,264189,265573,267124,268482,269518,270864,273409,276228,279178,281855,284200,285550,287163,289790,292967,295959,299374,301831,303457,305113,308213,311932,315395,318335,320986,322695,324632,328024,331443,334352,335752,337631,339061,341063,344692,348421,351866,354019,356522,357963,360061,363752,367681,371646,375737,379070,381069,383164,387641,391667,395638,399534,402962,404830,406344,409075,413480,417661,421493,424834,426729,428699,432730,436683,440707,444315,447084,448925,450971,454445,458322,462064,465685,468282,469646,471251,474323,477641,480816,483728,485911,487035,487981,489708,492108,494580,497226,499023,500232,501527,503795,506965,509328,511434,512937,513991,515524,517467,519957,521888,523663,525162,525844,526574,528369,529926,531487,533050,534780,535356,536098,537263,538436,540047,541144,541927,542359,542949]
cumrecovers = [34151,35442,37645,39405,42032,44094,51390,53630,54438,58117,61519,63547,81469,90445,91001,94745,139299,147484,153947,164015,175382,180152,187180,189791,189910,195036,198993,212534,216169,232733,230287,243430,246414,250747,268376,272265,283178,289392,294312,298418,350135,361239,366736,379157,384902,391508,399991,406446,416461,444758,458231,463868,479258,485002,491706,500849,506367,518522,524855,533504,540292,547386,556606,561816,576334,583503,592191,599115,606715,617460,622133,640198,647548,656161,663562,670809,679308,685164,705203,720631,729994,781970,790404,894325,906763,924148,936476,953462,969111,983185,995576,1006326,1031939,1049098,1075882,1090645,1107204,1122720,1131121,1160087,1182018,1210849,1233269,1261624,1279414,1297863,1325804,1355363,1389425,1414155,1438160,1461885,1468689,1513446,1528979,1577851,1598624,1623870,1643118,1656864,1670755,1714960,1753760,1774648,1796326,1818527,1833067,1865580,1898159,1925049,1947035,1965056,1985484,1997761,2020774,2053699,2084465,2101326,2118367,2140614,2153939,2184825,2202663,2231757,2266957,2283454,2302187,2315995,2333551,2359111,2387479,2403511,2417878,2434658,2451406,2474570,2495127,2525573,2540334,2556465,2577446,2590671,2615949,2646959,2670256,2710183,2727335,2750459,2766280,2794608,2813305,2840688,2860650,2873369,2897322,2911699,2935142,2952390,2999895,3021252,3039089,3062983,3075077,3106728,3124593,3155794,3177397,3197539,3220573,3234138,3272603,3295148,3323354,3353056,3375427,3406656,3422878,3460455,3487666,3518140,3554336,3578452,3612478,3630579,3674981,3705130,3743527,3781751,3810791,3851465,3881491,3928845,3961873,3997175,4051256,4095146,4148444,4185463,4244811,4293640,4350789,4410709,4457930,4529700,4526513,4633600,4696664,4835956,4871203,4947446,5023063,5065030,5146319,5226581,5322128,5404018,5470389,5576026,5624444,5714557,5786915,5889896,5985047,6135314,6246605,6298082,6399531,6490879,6597661,6681651,6756160,6882996,6935156,7043814,7127027,7234883,7337694,7362280,7473612,7530424,7603260,7702010,7807570,7919313,8345191,8091965,8135630,8299717,8377851,8475427,8588540,8662589,8766538,8808561,8925430,9009581,9100695,9221778,9283484,9363227,9405384,9484323,9593594,9713849,9762343,9866006,9936969,9978054,10100012,10173805,10274251,10398441,10461554,10545102,10586107,10692853,10750867,10838960,10971748,11030782,11109275,11143823,11227412,11300084,11415720,11490993,11548127,11611040,11642098,11723779,11770637,11828030,11901429,11936405,12004063,12025963,12077214,10487496,10554761,10611732,10643188,10696300,10717872,10746935,10778397,10809992,10855515,10882166,10882166,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]

cumcases=np.array(cumcases)
cumdeaths=np.array(cumdeaths)
cumrecovers = np.array(cumrecovers)
#cumdeaths=np.array([1058,1374,1782,2333,2837,3425,4332,5336,6514,7799,9280,10619,11932,13976,15973,18035,20107,22186,23886,25516,27869,30415,32612,34730,36621,38384,40199,42680,44762,46576,48548,50175,51397,52684,54761,57446,59599,61407,62938,64181,65209,67703,69619,72371,74152,75608,76640,77534,79040,80774,82626,84161,85398,86271,87126,88444,89843,91220,92511,93549,94238,94793,95458,96793,98031,99202,100127,100780,101460,102433,103407,104288,105125,105839,106285,106959,107850,108738,109636,110402,111095,111451,111838,112556,113335,114020,114669,115284,115577,115866,116588,117295,117942,118563,119066,119339,119677,120257,120953,121652,122254,122554,122761,122996,123906,124724,125589,126424,127177,127651,127981,128726,129585,130525,131467,132341,132868,133243,134289,135431,136505,137685,138694,139254,140317,141442,142939,144184,145513,146711,147205,147722,148966,150321,151558,152889,153973,154588,155018,156348,157861,159025,160245,161471,162089,162498,163686,165099,166221,167338,168374,168948,169292,170437,171734,172862,173886,174901,175375,175752,176771,177803,178874,179876,180802,181250,181477,181827,182919,184075,185089,185910,186300,186705,187745,188929,189807,190708,191459,191783,192066,192925,194084,195017,195866,196740,197047,197292,198024,199084,199943,200787,201530,201903,202233,202855,203777,204765,205670,206360,206829,207114,207838,208636,209564,210458,211235,211637,212088,212918,213943,215069,216010,216907,217294,217693,218622,219667,220722,221669,222639,223037,223511,225036,226162,227317,228503,229635,230136,230716,232073,233652,234763,236067,237419,238127,238736,240298,242180,244200,246094,247648,248565,249423,251529,253809,255196,256588,257839,258662,259697,262203,265007,267832,270405,272885,274030,275327,278030,281194,284309,287058,289552,291046,292404,295375,298823,302261,305127,307850,309483,310968,314099])
#cumcases=np.array([74404,92020,111274,131045,150709,171911,196848,223119,251182,283072,316130,342040,370283,400759,431718,466834,500442,531705,559820,584101,609975,639896,671423,703407,731357,758880,784847,810886,840062,872015,906241,941975,969289,991696,1016930,1043106,1073152,1105960,1135156,1160945,1183140,1205484,1230740,1257969,1285166,1310486,1331602,1349742,1372184,1393684,1420457,1445947,1469690,1490126,1510723,1531410,1552703,1579534,1603649,1626210,1645272,1663827,1680517,1699689,1722488,1746106,1769702,1791343,1811444,1831323,1851505,1871982,1895032,1917778,1936834,1953757,1970673,1991553,2013544,2036685,2062138,2083796,2102051,2124889,2149042,2176084,2206949,2239185,2268373,2295202,2328649,2367766,2407473,2451813,2494871,2536616,2576014,2623024,2674070,2727581,2781780,2836661,2881995,2922920,2973910,3036723,3095785,3162896,3225465,3287070,3344230,3402839,3472212,3542701,3619225,3683975,3748205,3804868,3867788,3937210,4008646,4083707,4148552,4209320,4263799,4322256,4386399,4455360,4523187,4583866,4637167,4679905,4731103,4783801,4837849,4898672,4952201,5002967,5044337,5099272,5155458,5207221,5264322,5320368,5362871,5400622,5440692,5485765,5529609,5576065,5622119,5660019,5694562,5731401,5775732,5819843,5865958,5909953,5948719,5980439,6022681,6053336,6097979,6149579,6194439,6227472,6255589,6277899,6308632,6346041,6390739,6432589,6467168,6500740,6535518,6575837,6619479,6666368,6712036,6747569,6786731,6835717,6875215,6918556,6973793,7021061,7056051,7091427,7128193,7173102,7218822,7268249,7319123,7357288,7395040,7433886,7485102,7540410,7597403,7655038,7701710,7744944,7791923,7849163,7912804,7981309,8038984,8086941,8144591,8205165,8266875,8340294,8422869,8506661,8571132,8634562,8706817,8786517,8875882,8973824,9065118,9207091,9290545,9380557,9485661,9604256,9733182,9864819,9977078,10095312,10228435,10377166,10534222,10708176,10875359,11022289,11172000,11331027,11498600,11685769,11882263,12065464,12219300,12373881,12539132,12726809,12855872,13054131,13205195,13342162,13491678,13670815,13872561,14087366,14316250,14534020,14716371,14897844,15113797,15328757,15548042,15783513,16008800,16195563,16388425,16579018,16810868,17051896,17291633,17494979,17691942,17870939,18061071,18282977,18487274,18613141,18803256,18956234,19119572])
index_2020_10_13 = list(dates).index('2020-10-13')

window_size=7
poly_max_order=1

daily_deaths = cumdeaths[1:]-cumdeaths[:-1]
filtered_daily_deaths = signal.savgol_filter(daily_deaths,window_size,poly_max_order)
daily_cases = cumcases[1:]-cumcases[:-1]
filtered_daily_cases = signal.savgol_filter(daily_cases,window_size,poly_max_order)


f,ax=plt.subplots()
ax.plot(filtered_daily_cases,'b')
ax.set_ylim([0,ax.get_ylim()[1]])
ax2 = ax.twinx()
ax2.plot(filtered_daily_deaths,'r')
ax2.set_ylim([0,ax2.get_ylim()[1]])

max_days = 20
active_cases = np.array([sum([daily_cases[i-j]*(1-mu_C)**(j) for j in range(min(max_days,i+1))]) for i in range(len(daily_cases))])
active_filtered_cases = np.array([sum([filtered_daily_cases[i-j]*(1-mu_C)**(j) for j in range(min(max_days,i+1))]) for i in range(len(daily_cases))])
active_filtered_cases = np.append(daily_cases[0],active_filtered_cases)

f,ax=plt.subplots()
ax.plot(active_cases,'b')
ax2 = ax.twinx()
ax2.plot(active_filtered_cases,'r')

inferred_recovered = cumcases-cumdeaths-active_filtered_cases

t0 = list(dates).index('2020-10-13')
t1 = 330
f,ax=plt.subplots()
ax.plot(filtered_daily_cases[t0:t1],'b')
ax.set_ylim([0,ax.get_ylim()[1]])
ax2 = ax.twinx()
ax2.plot(filtered_daily_deaths[t0:t1],'r')
ax2.set_ylim([0,ax2.get_ylim()[1]])

PLOT=False
sses=[]
for delay in range(30):
    x = filtered_daily_cases[t0:t1-delay]
    y = filtered_daily_deaths[t0+delay:t1]
    x = x/sum(x)
    y = y/sum(y)
    sse = sum([(xx-yy)**2 for xx,yy in zip(x,y)])
    sses.append(sse)
    print(delay,sse)

delay = np.argmin(sses)
x = filtered_daily_cases[t0:t1-delay]
y = filtered_daily_deaths[t0+delay:t1]
x = x/sum(x)
y = y/sum(y)
f,ax=plt.subplots()
ax.plot(x,'b',label='normalized cases')
ax.plot(y,'r',label='normalized death')
ax.set_ylim([0,ax.get_ylim()[1]])
ax.legend(loc='best')
ax.set_title('delay = '+str(delay))
plt.savefig('cases_vs_deaths_delay'+str(delay)+'.pdf')
#ax2 = ax.twinx()
#ax2.plot(y,'r')
